<!DOCTYPE html>
<html ng-app="aro">
  <head>
    <title><%= config.ui.title %></title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/sweetalert.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/select2.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/select2-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/nouislider.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/animate.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/aro.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/client_<%= config.ARO_CLIENT %>.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/layout_<%= config.ui.layout %>.css">
  </head>
  <body>

    <div ng-controller="data_management_controller">
      <% include modal_data_management.html %>
    </div>

    <div ng-controller="reports_controller">
      <% include modal_reports.html %>
    </div>

    <div ng-controller="build_lease_controller">
      <% include modal_build_lease.html %>
    </div>

    <div ng-controller="settings_controller">
      <% include modal_application_settings.html %>
    </div>

    <div ng-controller="selected_census_block_controller">
      <% include modal_census_block.html %>
    </div>

    <div ng-controller="customer_profile_controller">
      <% include modal_customer_profile.html %>
    </div>

    <div ng-controller="user_defined_boundary_controller">
      <% include modal_user_defined_boundaries.html %>
    </div>

    <div ng-controller="upload_customers_controller">
      <% include modal_upload_customers.html %>
    </div>
    
    <div ng-controller="upload_morphology_controller">
      <% include modal_upload_morphology.html %>
    </div>

    <div ng-controller="upload_fiber_controller">
      <% include modal_upload_fiber.html %>
    </div>

    <% if (user.rol === 'admin') { %>
      <div ng-controller="admin_users_controller">
        <% include modal_manage_users.html %>
        <% include modal_new_user.html %>
        <% include modal_send_mail.html %>
      </div>
    <% } %>

    <div ng-controller="navigation_menu_controller">

      <% include modal_build_sequence.html %>

      <div id="home_screen" ng-show="!plan">
        <div class="container">
          <div class="row">
            <div class="col-sm-12">
              <img id="aro_logo" src="/images/logos/<%= config.ARO_CLIENT %>/logo.png">
            </div>
            <div class="col-sm-8">
              <a id="btnNewPlan" href="javascript:void(0)" class="btn btn-primary btn-block" ng-click="new_plan()">Create New Network Plan</a>
              <br>
            </div>
            <div class="col-sm-8">
              <a id="btnExistingPlans" href="javascript:void(0)" class="btn btn-primary btn-block" ng-click="showPlans()">Existing Plans</a>
              <br>
            </div>
            <!--
            <div class="col-sm-8">
              <a href="javascript:void(0)" class="btn btn-primary btn-block" ng-click="showReports()">Reports</a>
              <br>
            </div>
            -->
            <% if (user.rol === 'admin') { %>
              <div class="col-sm-8">
                <a href="#manage-users" class="btn btn-primary btn-block" data-toggle="modal">Manage Users</a>
                <br>
              </div>
              <div class="col-sm-8">
                <a href="#application-settings" class="btn btn-primary btn-block" data-toggle="modal">Application Settings</a>
                <br>
              </div>
            <% } %>

            <div class="col-sm-8">
              <a href="#data-management" class="btn btn-primary btn-block" data-toggle="modal">Data Management</a>
              <br>
            </div>
          </div>
        </div>
      </div>

      <% include modal_select_plan.html %>

      <% include modal_new_plan.html %>

      <% include modal_edit_plan.html %>

      <% include modal_share_plan.html %>

      <% include modal_plan_combo.html %>

      <div class="modal" id="export-plan" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title">Export route</h4>
            </div>
            <div class="modal-body">
              <form class="form-horizontal">
                <div class="form-group">
                  <label class="col-sm-3 control-label">Filename</label>
                  <div class="col-sm-9">
                    <div class="input-group">
                      <input type="text" class="form-control" ng-model="kml_file_name">
                      <span class="input-group-addon">.kml</span>
                    </div>
                  </div>
                </div>
                <span id="export-error" style="display: none">Filename can only contain letters and numbers!</span>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" ng-click="export_kml()">Export file</button>
            </div>
          </div>
        </div>
      </div>

      <nav class="navbar navbar-default" id="top-navbar">
        <div class="container-fluid navbar-container">

          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#" id="brand" ng-click="selectPlan(null)"></a>
          </div>

          <div class="collapse navbar-collapse">
            <div class="nav navbar-nav navbar-right">
              <% if (config.ARO_CLIENT === 'verizon') { %>
                <img src="/images/logos/verizon/fimlogo.png" style="padding-top: 20px; max-height: 70px">
              <% } %>
            </div>
          </div>
        </div>
      </nav>

      <nav class="navbar navbar-default">
        <div class="container-fluid navbar-container">

          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <!-- Navbar brand. Hacky solution to get everything vertically centered -->
            <a class="navbar-brand" style="padding: 0px" href="#">
              <span style="line-height: 50px"><img src="images/logos/aro/logo_navbar.png" style="margin-top: -4px"></span>
              ARO
            </a>
          </div>

          <div class="collapse navbar-collapse">
            <!--
            <div style="font-size: 110%; padding-top: 3px">
              <p class="navbar-text saving" id="plan-saving">
                <span class="label label-default"><span class="spin fa fa-repeat"></span> <span class="text">Saving plan…</span></span>
              </p>
              <p class="navbar-text saving" id="plan-saved">
                <span class="label label-default"><span class="fa fa-check"></span> Plan saved</span>
              </p>
            </div>
            -->

            <!--<div style="float:left; width:200px" id="plan-saving-progress">
              <div class="progress" style="margin-bottom:0; margin-top:19px;">
                <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0%"></div>
              </div>
            </div>-->

<!--             <p class="navbar-text" ng-show="plan">
              <a style="cursor:pointer; color:white" data-target="#build-sequence" data-toggle="modal"><small>Build Sequence</small></a>
            </p> -->

<!--             <div class="navbar-text" style="width: 200px" ng-show="plan">
              <div id="year-slider"></div>
            </div> -->

            <ul class="nav navbar-nav navbar-right">
              <li class="dropdown">
                <a href="javascript:void(0)" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                  <%= user.first_name %> <%= user.last_name %>
                  <span class="caret"></span> &nbsp;
                  <span class="fa fa-user"></span>
                </a>
                <ul class="dropdown-menu">
                  <li><a href="/settings/show">
                    <span class="fa fa-cog"></span>
                    Account settings
                  </a></li>
                  <li><a href="/logout">
                    <span class="fa fa-power-off"></span>
                    Log out
                  </a></li>
                </ul>
              </li>
              <li class="dropdown" ng-show="plan" id="network_plan_menu">
                <a href="javascript:void(0)" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                  <span class="fa fa-cog"></span>
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                  <li><a href="javascript:;" ng-click="openReports()">Reports…</a></li>
                  <li><a href="javascript:void(0)" ng-click="save_as()" ng-show="plan.owner_id === user_id">Save as…</a></li>
                  <li role="separator" class="divider" ng-show="plan.owner_id === user_id"></li>
                  <li><a href="javascript:void(0)" ng-click="clearPlan()"
                    <% if (!env_is_test) { %>ng-show="plan.owner_id === user_id"<% } %> >Clear plan</a></li>
                  <li><a href="javascript:void(0)" ng-click="delete_plan(plan)"
                    <% if (!env_is_test) { %>ng-show="plan.owner_id === user_id"<% } %> >Delete plan</a></li>
                  <li role="separator" class="divider" ng-show="plan.owner_id === user_id"></li>
                  <li><a href="javascript:void(0)" ng-click="show_share_plan(plan)">Share…</a></li>
                  <% if (config.route_planning.length > 0) { %>
                  <li><a href="javascript:void(0)" ng-click="exportKmlName()">Export KML…</a></li>
                  <% } %>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <div id="aro-header">
        <div class="header-container">
          <div class="header-column-child-width">
            <a href="#" ng-click="selectPlan(null)"><span class="fa fa-caret-left fa-2x header-back-button"></span></a>
          </div>
          <div class="header-column-child-width">
            <div class="header-plan" ng-click="showCombo()">{{plan.name}}</div>
          </div>
          <div class="header-column-child-width">
            <div class="header-plan-location"><span class="fa fa-map-marker pad10"></span>{{plan.area_name}}</div>
          </div>
          <div class="header-column-child-width" id="plan-saving-progress">
            <div class="progress plan-progress">
              <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          <div class="header-column-fill-width">
            <p ng-show="plan" class="pull-right header-financials-container" id="top_bar_tools">

              <span ng-show="plan.ranOptimization" class="header-financials-item">{{plan.metadata.npv / 1000 | currency:"<%- config.currency_symbol %>":0}}K NPV</span>
              <span ng-hide="plan.ranOptimization" class="header-financials-item"><%- config.currency_symbol %>0K NPV</span>
              |
              <span ng-show="plan.ranOptimization" class="header-financials-item">{{(plan.metadata.irr * 100) | number : 1}}% IRR</span>
              <span ng-hide="plan.ranOptimization" class="header-financials-item">0% IRR</span>
              |
              <span id="shortest_path_total_cost" class="header-financials-item header-financials-capex">{{plan.metadata.total_cost / 1000 | currency:"<%- config.currency_symbol %>":0}}K CapEx</span>

            </p>
          </div>
        </div>
      </div>
    </div>


    <div id="left-col-wrapper">
      <div id="left-col" class="left-col-expanded">
        <div style="pointer-events: auto">
        <% if (config.ui.layout === 'accordion') { %>
          <% include layout_accordion.html %>
        <% } else if (config.ui.layout === 'default') { %>
          <% include layout_default.html %>
        <% } %>
        </div>
      </div>
    </div>

    <% if (config.ui.layout === 'default') { %>
      <div id="global-search">
        <% include controller_global_search.html %>
      </div>
    <% } %>

    <div ng-controller="selected_location_controller">

      <% if (env_is_test) { %>
        <a class="pull-right" ng-click="select_random_location()">.</a>
      <% } %>

      <% include modal_selected_location.html %>

    </div>
    
    <div ng-controller="expert_mode_controller">
      <% include modal_expert_mode.html %>
    </div>

    <div ng-controller="selected_fiber_controller">
      <% include controller_selected_fiber.html %>
    </div>

    <div ng-controller="route_controller">
    </div>

    <div ng-controller="market_size_controller">
      <% include modal_market_profile.html %>
    </div>

    <div id="map-canvas-wrapper">
      <div id="map-canvas"></div>
    </div>

    <div ng-controller="contextual_menu_controller">
      <ul class="dropdown-menu" id="contextual_menu">
        <li ng-repeat="option in options">
          <a href="javascript:void(0)" ng-click="select_option($index)">{{option.label}}</a>
        </li>
      </ul>
    </div>

    <div id="loader-wrapper"><div class="loader"></div></div>

  </body>

  <!-- Angular controllers and services -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-animate.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp<%- googleMapsKey ? '&amp;key=' + googleMapsKey : '' %>&amp;libraries=visualization,drawing"></script>

  <script>
    var app = angular.module('aro', ['ngAnimate']);
    var map;

    function initialize() {
      var styles = [];
      styles.push({
        featureType: 'poi',
        elementType: 'labels',
        stylers: [ { visibility: 'off' } ],
      });

      map = new google.maps.Map(document.getElementById('map-canvas'), {
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        panControl: false,
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.SMALL,
          position: google.maps.ControlPosition.TOP_RIGHT
        },
        mapTypeControlOptions: {
          position: google.maps.ControlPosition.TOP_RIGHT
        },
        styles: styles,
      });

      map.ready = function(callback) {
        if (map.getBounds()) {
          callback();
        } else {
          var listener = google.maps.event.addListener(map, 'bounds_changed', function() {
            callback();
            google.maps.event.removeListener(listener);
          });
        }
      }
    }

    var user_id = <%= user.id %>;
    var globalUser = <%- JSON.stringify(user) %>;
    var config = <%- JSON.stringify(config) %>;
    var globalServiceLayers = <%- JSON.stringify(serviceLayers) %>;
    var globalAnalysisLayers = <%- JSON.stringify(analysisLayers) %>;
    var globalExistingFiberSourceNames = <%- JSON.stringify(existingFiberSourceNames) %>;

    $(document).ready(initialize);
  </script>
  <script src="javascripts/vendors/bootstrap.min.js"></script>
  <script src="javascripts/vendors/underscore.js"></script>
  <script src="javascripts/vendors/sweetalert.min.js"></script>
  <script src="javascripts/vendors/Chart.min.js"></script>
  <script src="javascripts/vendors/select2.min.js"></script>
  <script src="javascripts/vendors/tinycolor.js"></script>
  <script src="javascripts/vendors/randomColor.min.js"></script>
  <script src="javascripts/vendors/Chart.StackedBar.js"></script>
  <script src="javascripts/vendors/nouislider.min.js"></script>

  <script src="javascripts/lib/controllers/customer_profile_controller.js"></script>
  <script src="javascripts/lib/controllers/navigation_menu_controller.js"></script>
  <script src="javascripts/lib/controllers/route_controller.js"></script>
  <script src="javascripts/lib/controllers/boundaries_controller.js"></script>
  <script src="javascripts/lib/controllers/locations_controller.js"></script>
  <script src="javascripts/lib/controllers/market_size_controller.js"></script>
  <script src="javascripts/lib/controllers/equipment_nodes_controller.js"></script>
  <script src="javascripts/lib/controllers/fiber_plant_controller.js"></script>
  <script src="javascripts/lib/controllers/selected_location_controller.js"></script>
  <script src="javascripts/lib/controllers/expert_mode_controller.js"></script>
  <script src="javascripts/lib/controllers/selected_fiber_controller.js"></script>
  <script src="javascripts/lib/controllers/contextual_menu_controller.js"></script>
  <script src="javascripts/lib/controllers/admin_users_controller.js"></script>
  <script src="javascripts/lib/controllers/search_controller.js"></script>
  <script src="javascripts/lib/controllers/area_network_planning_controller.js"></script>
  <script src="javascripts/lib/controllers/financial_profile_tool_controller.js"></script>
  <script src="javascripts/lib/controllers/target_builder_controller.js"></script>
  <script src="javascripts/lib/controllers/legend_controller.js"></script>
  <script src="javascripts/lib/controllers/global_search_controller.js"></script>
  <script src="javascripts/lib/controllers/map_tools_controller.js"></script>
  <script src="javascripts/lib/controllers/selected_census_block_controller.js"></script>
  <script src="javascripts/lib/controllers/settings_controller.js"></script>
  <script src="javascripts/lib/controllers/build_lease_controller.js"></script>
  <script src="javascripts/lib/controllers/user_defined_boundary_controller.js"></script>
  <script src="javascripts/lib/controllers/upload_customers_controller.js"></script>
  <script src="javascripts/lib/controllers/upload_morphology_controller.js"></script>
  <script src="javascripts/lib/controllers/upload_fiber_controller.js"></script>
  <script src="javascripts/lib/controllers/reports_controller.js"></script>
  <script src="javascripts/lib/controllers/backhaul_controller.js"></script>
  <script src="javascripts/lib/controllers/data_management_controller.js"></script>
  <script src="javascripts/lib/models/configuration.js"></script>
  <script src="javascripts/lib/models/tracker.js"></script>
  <script src="javascripts/lib/models/map_utils.js"></script>
  <script src="javascripts/lib/models/map_layer.js"></script>
  <script src="javascripts/lib/models/selection.js"></script>
  <script src="javascripts/lib/models/regions.js"></script>
  <script src="javascripts/lib/models/loader.js"></script>
  <script src="javascripts/lib/models/map_tools.js"></script>
  <script src="javascripts/lib/models/custom_overlay.js"></script>
  <script src="javascripts/lib/models/map_layers.js"></script>
  <script src="javascripts/lib/models/state.js"></script>
  <script src="javascripts/lib/models/optimization.js"></script>
  <script src="javascripts/lib/interceptors/http_error_handler.js"></script>
  <script src="javascripts/lib/interceptors/saving_plan_handler.js"></script>
  <script>app.run(function(loader){})</script>
  <script>
    $(function () {
      var tooltips = $('#left-col [data-toggle="tooltip"]')
      tooltips.tooltip()
      tooltips.on('click mouseout', function () {
        $(this).tooltip('hide')
      })
    })

    $(function () {
      var popovers = $('#left-col [data-toggle="popover"]')
      popovers.popover()
    })

    var expander = $('#expander')
    var icon = $('#expander .fa')
    var leftcol = $('#left-col')
    expander.on('click', function () {
      if (leftcol.hasClass('left-col-expanded')) {
        $('#map-tools-accordion .collapse.in').removeClass('in')
        icon.removeClass('fa-chevron-left')
        icon.addClass('fa-chevron-right')
        leftcol.removeClass('left-col-expanded')
        leftcol.addClass('left-col-collapsed')
      } else {
        icon.addClass('fa-chevron-left')
        icon.removeClass('fa-chevron-right')
        leftcol.removeClass('left-col-collapsed')
        leftcol.addClass('left-col-expanded')
      }
    })

    swal.setDefaults({ animation: <%- env_is_test ? 'null' : 'true' %> })

    // prevent tabs from changing the URL
    $('.nav-tabs a').click((e) => {
      e.preventDefault()
      $(this).tab('show')
    })

    if ($('#map-tools-accordion').size() > 0) {
      var heightDiff = $('#map-tools-accordion').offset().top + $('#map-tools-accordion').height() + 100
      function calculatePanelHeight () {
        var maxHeight = $(document).height() - heightDiff
        $('#map-tools-accordion .panel-collapse > .panel-body').css('max-height', maxHeight)
      }

      $(document).ready(calculatePanelHeight)
      $(window).resize(calculatePanelHeight)
    }

    $("#share-plan-search").select2({
      ajax: {
        url: "/user/find",
        dataType: 'json',
        delay: 250,
        data: function (text) {
          return {
            text: text,
          };
        },
        processResults: function (data, page) {
          // parse the results into the format expected by Select2.
          // since we are using custom formatting functions we do not need to
          // alter the remote JSON data
          data.forEach(function(row) {
            row.text = row.first_name+' '+row.last_name+' &lt;'+row.email+'&gt;';
          })
          return {
            results: data,
          };
        },
        cache: true
      },
      escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
      minimumInputLength: 1,
    })
  </script>
  <script src="javascripts/lib/interceptors/custom_locale.js"></script>
  <% if (env_is_production) { %>
    <!-- start UserSnap -->
    <script type="text/javascript">
      (function() {
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = '//api.usersnap.com/load/'+
                'b66398cb-a9b4-49b0-a828-715f6f7b3ca1.js';
        var x = document.getElementsByTagName('script')[0];
        x.parentNode.insertBefore(s, x);
      })();
    </script>
    <!-- end UserSnap -->
    <!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
  mixpanel.init("dfbe83f6bce5cb8321654ecde92e6111");</script><!-- end Mixpanel -->
  <% } %>
</html>
