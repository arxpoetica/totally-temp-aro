<!DOCTYPE html>
<html ng-app="aro">
  <head>
    <title ng-bind="appTitle"></title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Exo:400,700" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap-multiselect.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/sweetalert.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/select2.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/select2-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/angular-ui-select.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/angular-ui-select.aro.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/nouislider.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/angular-ui-notification.min.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/animate.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/aro.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/editor-interfaces.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/client_<%= config.ARO_CLIENT %>.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/layout_<%= config.ui.layout %>.css">

    <!-- Putting google maps include here because sometimes our app code loads before maps, and tries to use the map. It is going
         to be a bit of work getting to all legacy places in the code that use the map. Plus, the maps js file is ~30kB so it shouldn't
         affect things too much -->
    <!-- For google maps licensing, we can get either 1. An API key, 2. A ClientID(+ optional Channel) combo, or 3. None of the above (free tier) -->
    <%if (googleMapsLicensing.API_KEY) {%>
      <script src="https://maps.googleapis.com/maps/api/js?v=3<%- '&amp;key=' + googleMapsLicensing.API_KEY %>&amp;libraries=visualization,drawing"></script>
    <%} else if (googleMapsLicensing.CLIENT_ID) {%>
      <script src="https://maps.googleapis.com/maps/api/js?v=3<%- '&amp;client=' + googleMapsLicensing.CLIENT_ID %><%- googleMapsLicensing.CHANNEL ? '&amp;channel=' + googleMapsLicensing.CHANNEL : '' %>&amp;libraries=visualization,drawing"></script>
    <%} else {%>
      <script src="https://maps.googleapis.com/maps/api/js?v=3&amp;libraries=visualization,drawing"></script>
    <%}%>

    <!-- Include bundles with vendor scripts -->
    <script src="javascripts/vendors/vendor-bundle.min.js"></script>
  </head>
  <body ng-controller="body_controller">

    <!-- The tile component subscribes to map layer events raised from state.js. Include it before changing the state -->
    <tile map-global-object-name="map"></tile>

    <div ng-controller="data_management_controller">
      <% include modal_data_management.html %>
    </div>

    <div ng-controller="build_lease_controller">
      <% include modal_build_lease.html %>
    </div>

    <div ng-controller="settings_controller">
      <% include modal_application_settings.html %>
    </div>

    <div ng-controller="selected_census_block_controller">
      <% include modal_census_block.html %>
    </div>

    <div ng-controller="customer_profile_controller">
      <% include modal_customer_profile.html %>
    </div>

    <!-- Remove controller for now. Later, the whole navigation div should be gone<div ng-controller="navigation_menu_controller">-->
    <div>

      <% include modal_build_sequence.html %>

      <% include modal_share_plan.html %>

    </div>


    <div id="left-col-wrapper">
      <div id="left-col" class="left-col-expanded">
        <div style="pointer-events: auto">
        <% if (config.ui.layout === 'accordion') { %>
          <% include layout_accordion.html %>
        <% } else if (config.ui.layout === 'default') { %>
          <% include layout_default.html %>
        <% } %>
        </div>
      </div>
    </div>

    <div ng-controller="selected_location_controller">

      <% if (env_is_test) { %>
        <a class="pull-right" ng-click="select_random_location()">.</a>
      <% } %>

      <% include modal_selected_location.html %>

    </div>
    
    <div ng-controller="expert_mode_controller">
      <% include modal_expert_mode.html %>
    </div>

    <div ng-controller="selected_fiber_controller">
      <% include controller_selected_fiber.html %>
    </div>

    <div ng-controller="route_controller">
    </div>

    <div ng-controller="market_size_controller">
      <% include modal_market_profile.html %>
    </div>

    <map-split></map-split>

    <div ng-controller="contextual_menu_controller">
      <ul class="dropdown-menu" id="contextual_menu">
        <li ng-repeat="option in options">
          <a href="javascript:void(0)" ng-click="select_option($index)">{{option.label}}</a>
        </li>
      </ul>
    </div>

    <div id="loader-wrapper"><div class="loader"></div></div>
    <div growl></div>
    <div class="infobox" desc="shows fiber strand count">0</div>
    <fiber-strand-info></fiber-strand-info>
    <global-data-source-upload-modal></global-data-source-upload-modal> 
    <global-settings></global-settings>
    <network-plan-modal></network-plan-modal>
    <report-modal></report-modal>
    <network-analysis-modal></network-analysis-modal>
    <plan-resource-editor-modal show-modal="state.showPlanResourceEditorModal"
                                selected-resource-key="state.editingPlanResourceKey">
    </plan-resource-editor-modal>
    <aro-panel></aro-panel>
    <equipment-detail-modal></equipment-detail-modal>
    <plan-inputs-modal></plan-inputs-modal>
  </body>

  <!-- Angular controllers and services -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-animate.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    var app = angular.module('aro', ['ngAnimate','ui-notification', 'ui.select', 'ng-currency']);
    app.config(['NotificationProvider', '$qProvider', function (NotificationProvider, $qProvider) {
      NotificationProvider.setOptions({
        maxCount : 1
      });
      $qProvider.errorOnUnhandledRejections(false);
    }]);
    var map;
    var panorama;

    function initialize() {

      var styles = [];
      styles.push({
        featureType: 'poi',
        elementType: 'labels',
        stylers: [ { visibility: 'off' } ],
      });

      map = new google.maps.Map(document.getElementById('map-canvas'), {
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        panControl: false,
        mapTypeControl: false,
        mapTypeControlOptions: {
          position: google.maps.ControlPosition.BOTTOM_RIGHT
        },
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.SMALL,
          position: google.maps.ControlPosition.RIGHT_BOTTOM
        },
        streetViewControl: true,
        streetViewControlOptions: {
          position: google.maps.ControlPosition.RIGHT_BOTTOM,
          enableCloseButton: true
        },
        styles: styles,
      });
      
      mapTypeId === 'SATELLITE' && map.setMapTypeId(google.maps.MapTypeId.HYBRID);

      var splitterInitialized = false
      map.ready = function(callback) {

        if (map.getBounds()) {
          callback();
        } else {
          var listener = google.maps.event.addListener(map, 'bounds_changed', function() {
            callback();
            google.maps.event.removeListener(listener);
          });
        }
      }

      var thePanorama = map.getStreetView();
      // change view
      google.maps.event.addListener(thePanorama, 'visible_changed', function () {
        // Display your street view visible UI
        if (thePanorama.getVisible()) {

          panorama = new google.maps.StreetViewPanorama(
            document.getElementById('map-canvas'), {
              addressControlOptions: {
                position: google.maps.ControlPosition.BOTTOM_CENTER, // <- change position
              },
              enableCloseButton: true
            });
          // rewrite default options  
          map.setStreetView(panorama);
        }
      });

      // At this point, our angular app and the document is initialized. Take the "logged in user" that we have on the
      // server side, use EJS to expand it and then set that in our "state" service. This is done so that we don't
      // have to rely on a global user object (like we did before this change)
      angular.element(document.body).injector().get('state').setLoggedInUser(<%- JSON.stringify(user) %>);
    }

    var user_id = <%= user.id %>;
    var config = <%- JSON.stringify(config) %>;
    var globalServiceLayers = <%- JSON.stringify(serviceLayers) %>;
    var globalAnalysisLayers = <%- JSON.stringify(analysisLayers) %>;
    var globalExistingFiberSourceNames = <%- JSON.stringify(existingFiberSourceNames) %>;
    var mapTypeId = <%- JSON.stringify(mapType) %>;

    $(document).ready(initialize);
  </script>
  <script src="javascripts/vendors/bootstrap.min.js"></script>
  <script src="javascripts/vendors/bootstrap-multiselect.js"></script>
  <script src="javascripts/vendors/underscore.js"></script>
  <script src="javascripts/vendors/sweetalert.min.js"></script>
  <script src="javascripts/vendors/Chart.min.js"></script>
  <script src="javascripts/vendors/select2.min.js"></script>
  <script src="javascripts/vendors/angular-ui-select.min.js"></script>
  <script src="javascripts/vendors/tinycolor.js"></script>
  <script src="javascripts/vendors/randomColor.min.js"></script>
  <script src="javascripts/vendors/nouislider.min.js"></script>
  <script src="javascripts/vendors/angular-ui-notification.min.js"></script>
  <script src="javascripts/vendors/ng-currency.js"></script>
  <script src="javascripts/vendors/simpleheat.js"></script>
  <script src="javascripts/vendors/split.min.js"></script>
  
  <!-- Components -->
  <script src="javascripts/lib/components/footer/ui-notification-service.js"></script>
  <script src="javascripts/lib/components/tiles/tile-data-service.js"></script>
  
  <script src="javascripts/lib/controllers/body_controller.js"></script>
  <script src="javascripts/lib/controllers/customer_profile_controller.js"></script>
  <script src="javascripts/lib/controllers/route_controller.js"></script>
  <script src="javascripts/lib/controllers/locations_controller.js"></script>
  <script src="javascripts/lib/controllers/market_size_controller.js"></script>
  <script src="javascripts/lib/controllers/equipment_nodes_controller.js"></script>
  <script src="javascripts/lib/controllers/fiber_plant_controller.js"></script>
  <script src="javascripts/lib/controllers/selected_location_controller.js"></script>
  <script src="javascripts/lib/controllers/expert_mode_controller.js"></script>
  <script src="javascripts/lib/controllers/selected_fiber_controller.js"></script>
  <script src="javascripts/lib/controllers/contextual_menu_controller.js"></script>
  <script src="javascripts/lib/controllers/financial_profile_tool_controller.js"></script>
  <script src="javascripts/lib/controllers/legend_controller.js"></script>
  <script src="javascripts/lib/controllers/global_search_controller.js"></script>
  <script src="javascripts/lib/controllers/map_tools_controller.js"></script>
  <script src="javascripts/lib/controllers/selected_census_block_controller.js"></script>
  <script src="javascripts/lib/controllers/settings_controller.js"></script>
  <script src="javascripts/lib/controllers/build_lease_controller.js"></script>
  <script src="javascripts/lib/controllers/data_management_controller.js"></script>
  <script src="javascripts/lib/controllers/construction_sites_controller.js"></script>
  <script src="javascripts/lib/controllers/map_settings_controller.js"></script>
  <script src="javascripts/lib/models/configuration.js"></script>
  <script src="javascripts/lib/models/tracker.js"></script>
  <script src="javascripts/lib/models/map_utils.js"></script>
  <script src="javascripts/lib/models/map_layer.js"></script>
  <script src="javascripts/lib/models/selection.js"></script>
  <script src="javascripts/lib/models/regions.js"></script>
  <script src="javascripts/lib/models/loader.js"></script>
  <script src="javascripts/lib/models/map_tools.js"></script>
  <script src="javascripts/lib/models/custom_overlay.js"></script>
  <script src="javascripts/lib/models/map_layers.js"></script>
  <script src="javascripts/lib/models/state.js"></script>
  <script src="javascripts/lib/models/stateSerializationHelper.js"></script>
  <script src="javascripts/lib/models/optimization.js"></script>
  <script src="javascripts/lib/models/globalSettingsService.js"></script>
  <script src="javascripts/lib/interceptors/http_error_handler.js"></script>
  <script src="javascripts/lib/interceptors/saving_plan_handler.js"></script>
  <script src="javascripts/lib/directives/percentageInput.js"></script>
  <script src="javascripts/lib/directives/dialogs.js"></script>
  <script src="javascripts/lib/directives/modal.js"></script>
  
  <!-- models -->
  <script src="javascripts/bundle.js"></script>
  
  <script>app.run(function($rootScope,loader){$rootScope.appTitle = "<%= config.ui.title %>"})</script>
  <script>
    $(function () {
      var tooltips = $('[data-toggle="tooltip"]')
      tooltips.tooltip({ container: 'body' })
      tooltips.on('click mouseout', function () {
        $(this).tooltip('hide')
      })
    })

    $(function () {
      var popovers = $('#left-col [data-toggle="popover"]')
      popovers.popover({container: 'body'})
    })

    var expander = $('#expander')
    var icon = $('#expander .fa')
    var leftcol = $('#left-col')
    expander.on('click', function () {
      if (leftcol.hasClass('left-col-expanded')) {
        $('#map-tools-accordion .collapse.in').removeClass('in')
        icon.removeClass('fa-chevron-left')
        icon.addClass('fa-chevron-right')
        leftcol.removeClass('left-col-expanded')
        leftcol.addClass('left-col-collapsed')
      } else {
        icon.addClass('fa-chevron-left')
        icon.removeClass('fa-chevron-right')
        leftcol.removeClass('left-col-collapsed')
        leftcol.addClass('left-col-expanded')
      }
    })

    swal.setDefaults({ animation: <%- env_is_test ? 'null' : 'true' %> })

    // prevent tabs from changing the URL
    $('.nav-tabs a').click((e) => {
      e.preventDefault()
      $(this).tab('show')
    })

    if ($('#map-tools-accordion').size() > 0) {
      var heightDiff = $('#map-tools-accordion').offset().top + $('#map-tools-accordion').height() + 100
      function calculatePanelHeight () {
        var maxHeight = $(document).height() - heightDiff
        $('#map-tools-accordion .panel-collapse > .panel-body').css('max-height', maxHeight)
      }

      $(document).ready(calculatePanelHeight)
      $(window).resize(calculatePanelHeight)
    }

    $("#share-plan-search").select2({
      ajax: {
        url: "/user/find",
        dataType: 'json',
        delay: 250,
        data: function (text) {
          return {
            text: text,
          };
        },
        processResults: function (data, page) {
          // parse the results into the format expected by Select2.
          // since we are using custom formatting functions we do not need to
          // alter the remote JSON data
          data.forEach(function(row) {
            row.text = row.first_name+' '+row.last_name+' &lt;'+row.email+'&gt;';
          })
          return {
            results: data,
          };
        },
        cache: true
      },
      escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
      minimumInputLength: 1,
    })
  </script>
  <script src="javascripts/lib/interceptors/custom_locale.js"></script>
  <% if (env_is_production) { %>
    <!-- start UserSnap -->
    <script type="text/javascript">
      (function() {
        var s = document.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = '//api.usersnap.com/load/'+
                'b66398cb-a9b4-49b0-a828-715f6f7b3ca1.js';
        var x = document.getElementsByTagName('script')[0];
        x.parentNode.insertBefore(s, x);
      })();
    </script>
    <!-- end UserSnap -->
    <!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
  mixpanel.init("dfbe83f6bce5cb8321654ecde92e6111");</script><!-- end Mixpanel -->
  <% } %>
</html>
