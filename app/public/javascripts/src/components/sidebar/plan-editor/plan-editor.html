<style>
  .edit-plan-container {
    position: absolute;
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
  }
  #tblEquipmentProperties td {
    line-height: 33px;  /* To vertically align text */
  }
  #tblBoundaryProperties td {
    line-height: 33px;  /* To vertically align text */
  }
  .draggable-item-button {
    border: none;
  }
  .plan-editor-hr {
    margin-top: 10px;
    margin-bottom: 10px;
  }
  
  .plan-editor-bounds-contain{
    margin-top: 10px; 
    position: absolute;
    width: 100%;
    padding-right: 20px;
  }
  
</style>

<div class="edit-plan-container">
  <accordion style="position: relative; flex: 1 1 auto;" toggle-expanded-panel="$ctrl.state.activeEditPlanPanel">
    <accordion-panel-title title="'Edit Plan'" panel-id="$ctrl.state.EditPlanPanels.EDIT_PLAN"></accordion-panel-title>
    <accordion-panel-contents panel-id="$ctrl.state.EditPlanPanels.EDIT_PLAN">
      <div> <!-- ToDo: need to make this a sub component, need to figure out transaction sharing -->
            <!--  && $ctrl.state.activeEditPlanPanel === $ctrl.state.EditPlanPanels.EDIT_PLAN -->
        <!-- Add a component to handle map editing -->
        <map-object-editor ng-if="$ctrl.currentTransaction"
                          map-global-object-name="{{$ctrl.mapGlobalObjectName}}"
                          map-container-id="map-canvas-container"
                          get-object-icon-url="$ctrl.getObjectIconUrl({objectKey, objectValue})"
                          object-selected-icon-url="$ctrl.getObjectIconUrl({objectKey, objectValue})"
                          create-object-on-click="false"
                          
                          is-boundary-creation-allowed="$ctrl.isBoundaryCreationAllowed(mapObject)"
                          hide-object-ids="$ctrl.objectIdsToHide"
                          feature-type="equipment"
                          check-create-object="$ctrl.checkCanCreateObject(feature, usingMapClick)"
                          on-create-object="$ctrl.handleObjectCreated(mapObject, usingMapClick, feature, deleteExistingBoundary)"
                          on-modify-object="$ctrl.handleObjectModified(mapObject)"
                          on-select-object="$ctrl.handleSelectedObjectChanged(mapObject, isMult)"
                          on-delete-object="$ctrl.handleObjectDeleted(mapObject)"
                          display-view-object="$ctrl.displayViewObject(feature)"
                          display-edit-object="$ctrl.displayEditObject(feature, isMult)"
                          on-object-dropped-on-marker="$ctrl.handleObjectDroppedOnMarker({dropEvent: dropEvent, targetObjectId: targetObjectId})"
                          on-object-key-clicked="$ctrl.onMultiSelect(features, latLng)"
                          register-object-delete-callback="$ctrl.registerObjectDeleteCallback(deleteObjectWithId)"
                          register-create-map-objects-callback="$ctrl.registerCreateMapObjectsCallback(createMapObjects)"
                          register-remove-map-objects-callback="$ctrl.registerRemoveMapObjectsCallback(removeMapObjects)"
                          register-create-editable-existing-map-object="$ctrl.registerCreateEditableExistingMapObject(createEditableExistingMapObject)"
                          register-delete-created-map-object="$ctrl.registerDeleteCreatedMapObject(deleteCreatedMapObject)"
                          register-select-proposed-feature="$ctrl.registerSelectProposedFeature(selectProposedFeature)"
                          register-map-object-from-event="$ctrl.registerMapObjectFromEvent(mapObjectFromEvent)"
                          register-highlight-map-object="$ctrl.registerHighlightMapObject(highlightMapObject)"
                          register-dehighlight-map-object="$ctrl.registerDehighlightMapObject(dehighlightMapObject)">
        </map-object-editor>

        <div style="margin: 10px">

          <!-- Buttons to commit or discard a transaction -->
          <div class="text-center">
            <div class="btn-group ">
              <button class="btn btn-light" ng-click="$ctrl.commitTransaction($ctrl.currentTransaction.id)"><i class="fa fa-check-circle"></i>&nbsp;&nbsp;Commit</button>
              <button class="btn btn-light" ng-click="$ctrl.discardTransaction($ctrl.currentTransaction.id)"><i class="fa fa-times-circle"></i>&nbsp;&nbsp;Discard</button>
            </div>
          </div>
          <br>

          <!-- Section that allows the user to drag and drop equipment and boundaries onto the map -->
          <div style="width: 100%" ng-if="!$ctrl.isMultSelectActive()">
            <p class="text-center">Click and drag equipment/boundary onto the map</p>
            <hr class="plan-editor-hr">
            <!-- Equipment buttons. Only add the ones in the allEditableNetworkNodeTypes list -->
            <draggable-button ng-repeat="equipment in $ctrl.state.configuration.networkEquipment.equipments"
                              ng-if="$ctrl.allEditableNetworkNodeTypes.indexOf(equipment.networkNodeType) >= 0"
                              icon="{{equipment.iconUrl}}" 
                              is-disabled="false"
                              entity-type="networkEquipment"
                              entity-details="{{equipment.networkNodeType}}">
            </draggable-button>
            <hr class="plan-editor-hr">
            <!-- Boundary buttons -->
            <div ng-if="!$ctrl.state.showSiteBoundary" class="alert alert-warning">
              You can add site boundaries only if the "Site Boundaries" option is selected in View Settings
            </div>
            
            <div style="display: flex">
              <div style="flex: 0 0 auto; padding-right: 20px; line-height: 33px;">
                <input type="checkbox" class="checkboxfill" ng-checked="$ctrl.state.showSiteBoundary" ng-click="$ctrl.state.toggleSiteBoundary()" name="ctype-name"
                  style="margin: 0px;">
                  Site Boundaries
              </div>
              <select class="form-control" style="flex: 1 1 auto"
                ng-value="$ctrl.state.selectedBoundaryType.description"
                ng-if="$ctrl.state.showSiteBoundary" 
                ng-click="$ctrl.state.setSelectedBoundaryType($ctrl.state.boundaryTypes[$event.target.selectedIndex])">
                <option ng-repeat="item in $ctrl.state.boundaryTypes"
                  ng-selected="{{ item.id === $ctrl.state.selectedBoundaryType.id }}"
                  value="{{item.description}}">
                  {{item.description}}
                </option>
              </select>
            </div>
            
            <div ng-if="$ctrl.state.showSiteBoundary" style="display: flex; flex-direction: row; width: 100%">
              <div style="flex: 0 0 auto">
                <draggable-button icon="/images/map_icons/aro/boundary_road_segments.png"
                                  is-disabled="false"
                                  is-boundary="true"
                                  entity-details='{ "spatialEdgeType": "{{$ctrl.Constants.SPATIAL_EDGE_ROAD}}", "directed": false }'>
                </draggable-button>
              </div>
              <div style="flex: 0 0 auto">
                <draggable-button icon="/images/map_icons/aro/boundary_copper.png"
                                  is-disabled="false"
                                  is-boundary="true"
                                  entity-details='{ "spatialEdgeType": "{{$ctrl.Constants.SPATIAL_EDGE_COPPER}}", "directed": false }'>
                </draggable-button>
              </div>
              <div style="flex: 0 0 auto">
                <draggable-button icon="/images/map_icons/aro/boundary_copper_directed.png"
                                  is-disabled="false"
                                  is-boundary="true"
                                  entity-details='{ "spatialEdgeType": "{{$ctrl.Constants.SPATIAL_EDGE_COPPER}}", "directed": true }'>
                </draggable-button>
              </div>
              <div style="flex: 0 0 auto; line-height: 45px; padding-left: 5px; padding-right: 5px;">
                Distance ({{$ctrl.state.configuration.units.length_units}})
              </div>
              <div style="flex: 1 1 auto; margin-top: 5px; padding-left: 5px; padding-right: 5px;">
                <input class="form-control"
                        ng-model="$ctrl.lastUsedBoundaryDistance">
              </div>
            </div>
          </div>

          <!-- Section to show subnet calculation options -->
          <table id="tblPlanInfo" class="table table-sm table-striped" style="margin-top: 15px;">
            <tbody>
              <tr>
                <td>Fiber routing logic</td>
                <td>
                  <input type="checkbox" class="checkboxfill layer-type-checkboxes" style="margin: 0px;"
                        ng-model="$ctrl.autoRecalculateSubnet">
                    <span>Auto recalculate</span>
                </td>
                <td>
                  <input type="checkbox" class="checkboxfill layer-type-checkboxes" style="margin: 0px;"
                        ng-model="$ctrl.stickyAssignment">
                  <span>Sticky assignment</span>
                </td>
              </tr>
            </tbody>
          </table>
          
          
          <!-- Section for multi select actions -->
          <div class="clearfix" ng-if="$ctrl.selectedMapObject && $ctrl.isMarker($ctrl.selectedMapObject) && $ctrl.isMultSelectActive()" style="margin-top: 10px">
            <!-- Section header showing the type of the selected object -->
            <div class="sidebar-table-header" ng-if="$ctrl.getSelectedNetworkConfig()">
                <img ng-src="{{$ctrl.getSelectedNetworkConfig().iconUrl}}" style="vertical-align:middle; padding-right: 10px">
                <span>{{$ctrl.getSelectedNetworkConfig().label}}</span>
                <div class="sidebar-header-subinfo">
                  <div class="sidebar-header-subinfo-item">lat: {{$ctrl.selectedMapObjectLat}}</div>
                  <div class="sidebar-header-subinfo-item">long: {{$ctrl.selectedMapObjectLng}}</div>
                </div>
            </div>
            <div ng-if="$ctrl.getSelectedNetworkConfig().key === 'location_connector'" class="alert alert-warning" style="margin: 1rem 0 0 0">
              shift + click to select multiple Location Connectors
            </div>
            <div style="margin: 1rem 0 0 0">
              <button class="btn btn-danger float-right"
                      ng-click="$ctrl.requestDeleteMultiSelectGroup()"
                      style="margin-bottom: 10px">
                <i class="fa fa-trash-alt text-white"></i>&nbsp;&nbsp;Delete {{$ctrl.getMultiSelectCount()}}
              </button>
              <button class="btn btn-light float-right"
                      ng-click="$ctrl.mergeMultiSelectGroup()"
                      style="margin-bottom: 10px">
                <i class="fa fa-compress"></i>&nbsp;&nbsp;Merge {{$ctrl.getMultiSelectCount()}}
              </button>
            </div>
            <div>

            </div>
          </div>
          

          <!-- Section to show properties when the selected map object is an equipment node -->
          <div class="clearfix" ng-if="!$ctrl.isEditFeatureProps && $ctrl.viewFeature && !$ctrl.isMultSelectActive()" style="margin-top: 10px">
            <!-- Section header showing the type of the selected object -->
            <div class="sidebar-table-header">
                <img ng-src="{{$ctrl.viewIconUrl}}" style="vertical-align:middle; padding-right: 10px">
                <span>{{$ctrl.viewLabel}}</span>
                
                <button ng-class="{ 'btn ei-panel-header-btn-set ei-foldout-header-btn': true,
                  'btn-light': $ctrl.viewFeature.attributes.is_locked === 'true',
                  'btn-primary': $ctrl.viewFeature.attributes.is_locked !== 'true' }"
                  ng-disabled="$ctrl.viewFeature.attributes.is_locked === 'true'"
                  ng-click="$ctrl.editViewObject()">Edit</button>
                <div class="sidebar-header-subinfo">
                  <div class="sidebar-header-subinfo-item">lat: {{$ctrl.viewEventFeature.geometry.coordinates[1] | number : 6}}</div>
                  <div class="sidebar-header-subinfo-item">long: {{$ctrl.viewEventFeature.geometry.coordinates[0] | number : 6}}</div>
                </div>
            </div>
            
            <!-- A table containing the editable properties of the selected object -->
            <editor-interface-tree 
              ng-if="!$ctrl.isEditFeatureProps"
              object-to-view="$ctrl.viewFeature.networkNodeEquipment" 
              is-edit="false"
              root-meta-data="{'networkNodeType':$ctrl.viewFeature.siteNetworkNodeType}">
            </editor-interface-tree>
            

            <button ng-if="$ctrl.isEditFeatureProps"
                    ng-class="{ 'btn float-right': true,
                                'btn-light': !$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty,
                                'btn-primary': $ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty }"
                    ng-disabled="!$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty"
                    ng-click="$ctrl.saveSelectedEquipmentProperties()"
                    style="margin-bottom: 10px">
              <i class="fa fa-save"></i>&nbsp;&nbsp;Save equipment properties
            </button>
          </div>
          
          
          <!-- Section to show properties when the selected map object is an equipment node -->
          <div class="clearfix" ng-if="$ctrl.isEditFeatureProps && $ctrl.selectedMapObject && $ctrl.isMarker($ctrl.selectedMapObject) && !$ctrl.isMultSelectActive()" style="margin-top: 10px">
            <!-- Section header showing the type of the selected object -->
            <div class="sidebar-table-header" ng-if="$ctrl.getSelectedNetworkConfig()">
                <img ng-src="{{$ctrl.getSelectedNetworkConfig().iconUrl}}" style="vertical-align:middle; padding-right: 10px">
                <span>{{$ctrl.getSelectedNetworkConfig().label}}</span>
                <button class="btn btn-danger ei-panel-header-btn-set ei-foldout-header-btn"
                  ng-click="$ctrl.deleteObjectWithId($ctrl.selectedMapObject.objectId)">Delete</button>
                <div class="sidebar-header-subinfo">
                  <!-- <div class="sidebar-header-subinfo-item">lat: {{$ctrl.selectedMapObject.position.lat()}}</div>
                  <div class="sidebar-header-subinfo-item">long: {{$ctrl.selectedMapObject.position.lng()}}</div> -->
                  <form class="form-inline">
                    <div class="form-group" style="margin-bottom: 2px;">
                      <label for="selectedMapObjectLat">lat: </label>
                      <input type="number" class="form-control" id="selectedMapObjectLat"
                        placeholder="lat" 
                        ng-model="$ctrl.selectedMapObjectLat"
                        ng-model-options="{ debounce: 100 }"
                        step="0.000001"
                        ng-change="$ctrl.markSelectedEquipmentPropertiesDirty()">
                    </div>
                    <div class="form-group" style="margin-bottom: 2px;">
                      <label for="selectedMapObjectLng">long: </label>
                      <input type="number" class="form-control" id="selectedMapObjectLng"
                        placeholder="long" 
                        ng-model="$ctrl.selectedMapObjectLng"
                        ng-model-options="{ debounce: 100 }"
                        step="0.000001"
                        ng-change="$ctrl.markSelectedEquipmentPropertiesDirty()">
                    </div>
                  </form>
                </div>
            </div>
            <div ng-if="$ctrl.getSelectedNetworkConfig().key === 'location_connector'" class="alert alert-warning" style="margin: 1rem 0 0 0">
              right-click locations to toggle their connection
              <br>shift + click to select multiple Location Connectors
            </div>
            <!-- A table containing the editable properties of the selected object -->
            <editor-interface-tree 
                                on-change="$ctrl.markSelectedEquipmentPropertiesDirty()"
                                object-to-view="$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].networkNodeEquipment" 
                                is-edit="true"
                                root-meta-data="{'networkNodeType':$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].siteNetworkNodeType}"
                                get-new-list-item="$ctrl.getNewListItem"
                                ></editor-interface-tree>

            <button ng-class="{ 'btn float-right': true,
                                'btn-light': !$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty,
                                'btn-primary': $ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty }"
                    ng-disabled="!$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty"
                    ng-click="$ctrl.saveSelectedEquipmentProperties()"
                    style="margin-bottom: 10px">
              <i class="fa fa-save"></i>&nbsp;&nbsp;Save equipment properties
            </button>
          </div>

          <!-- Section to show properties when the selected map object is an equipment boundary - view-->
          <div class="plan-editor-bounds-contain" ng-if="$ctrl.state.showSiteBoundary && $ctrl.viewBoundaryProps && !$ctrl.isBoundaryEditMode && !$ctrl.isMultSelectActive()">
            <!-- A table containing the editable properties of the selected object -->
            <table id="tblBoundaryProperties" class="table table-sm table-striped sidebar-table" style="margin-bottom: 10px">
              <thead>
                <div class="clearfix" style="margin-top: 10px">
                  <!-- Section header showing the type of the selected object -->
                  <div class="sidebar-table-header">
                    <span>Site Boundary</span>
                    <button ng-class="{ 'btn ei-panel-header-btn-set ei-foldout-header-btn': true,
                      'btn-light': $ctrl.viewSiteBoundaryEventFeature.attributes.is_locked === 'true',
                      'btn-primary': $ctrl.viewSiteBoundaryEventFeature.attributes.is_locked !== 'true' }"
                  	  ng-disabled="$ctrl.viewSiteBoundaryEventFeature.attributes.is_locked === 'true'"
                  	  ng-click="$ctrl.editViewSiteBoundaryObject()">Edit</button>
                  </div>
              </thead>
              <tbody>
                <tr>
                  <td>Site boundary type</td>
                  <td>
                    {{$ctrl.viewBoundaryProps.selectedSiteBoundaryType.description}}
                  </td>
                </tr>
                <tr>
                  <td>Site move update</td>
                  <td>
                    {{$ctrl.viewBoundaryProps.selectedSiteMoveUpdate}}
                  </td>
                </tr>
                <tr>
                  <td>Site boundary generation</td>
                  <td>
                    {{$ctrl.viewBoundaryProps.selectedSiteBoundaryGeneration}}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Section to show properties when the selected map object is an equipment boundary - edit -->
          <div class="plan-editor-bounds-contain" ng-if="$ctrl.selectedMapObject && !$ctrl.isMarker($ctrl.selectedMapObject) && $ctrl.isBoundaryEditMode && !$ctrl.isMultSelectActive()">
            <!-- Section header showing the type of the selected object -->
            <div class="sidebar-table-header" ng-if="$ctrl.getSelectedBoundaryNetworkConfig()">
                <img src="/images/map_icons/aro/boundary_road_segments.png" style="vertical-align:middle; padding-right: 10px">
                <span>{{$ctrl.getSelectedBoundaryNetworkConfig().label}} boundary</span>
            </div>
            <!-- A table containing the editable properties of the selected object -->
            <table id="tblBoundaryProperties"
                  class="table table-sm table-striped sidebar-table"
                  style="margin-bottom: 10px">
              <thead>
                <div class="clearfix" ng-if="!$ctrl.getSelectedBoundaryNetworkConfig()" style="margin-top: 10px">
                  <!-- Section header showing the type of the selected object -->
                  <div class="sidebar-table-header">
                    <span>Site Boundary</span>
                  </div>
              </thead>
              <tbody>
                <tr>
                  <td>Site boundary type</td>
                  <td>
                    <select class="form-control"
                      ng-model="$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].selectedSiteBoundaryTypeId"
                      ng-options="item.id as item.description for item in $ctrl.state.boundaryTypes"
                      ng-change="$ctrl.markSelectedBoundaryPropertiesDirty(); $ctrl.handleSiteBoundaryTypeChanged();">
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Site move update</td>
                  <td>
                    <select class="form-control"
                      ng-model="$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].selectedSiteMoveUpdate"
                      ng-options="item as item for item in $ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].siteMoveUpdates"
                      ng-change="$ctrl.markSelectedBoundaryPropertiesDirty()">
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Site boundary generation</td>
                  <td>
                    <select class="form-control"
                      ng-model="$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].selectedSiteBoundaryGeneration"
                      ng-options="item as item for item in $ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].siteBoundaryGenerations"
                      ng-change="$ctrl.markSelectedBoundaryPropertiesDirty()">
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="clearfix">
              <button ng-class="{ 'btn float-right': true,
                                  'btn-light': !$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty,
                                  'btn-primary': $ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty }"
                      ng-disabled="!$ctrl.objectIdToProperties[$ctrl.selectedMapObject.objectId].isDirty"
                      ng-click="$ctrl.saveSelectedBoundaryProperties()"
                      style="margin-bottom: 10px">
                <i class="fa fa-save"></i>&nbsp;&nbsp;Save boundary properties
              </button>
            </div>
            
            <hr class="plan-editor-hr">
            
            <button class="btn btn-primary btn-sm" 
                    ng-click="$ctrl.onRequestCalculateCoverage()">
              calculate coverage
            </button>
            
            <boundary-coverage 
              bounds-input="$ctrl.coverageOutput"
              parent-selected-object-id="$ctrl.selectedObjectId"
              is-working-override="$ctrl.isWorkingOnCoverage">
            </boundary-coverage>
            
          </div>
          
          
          <!-- Add a div that will overlay all the controls above. The div will be visible when the controls need to be disabled. -->
          <div class="disable-sibling-controls"
               ng-show="!$ctrl.currentTransaction || $ctrl.isCalculatingSubnets || $ctrl.isCreatingObject || $ctrl.isModifyingObject">
          </div>
        </div>
      </div>
    </accordion-panel-contents>
    <!-- Plan Summary -->
    <accordion-panel-title title="'Plan Summary'" panel-id="$ctrl.state.EditPlanPanels.PLAN_SUMMARY"></accordion-panel-title>
    <accordion-panel-contents panel-id="$ctrl.state.EditPlanPanels.PLAN_SUMMARY">
      <plan-summary current-transaction="$ctrl.currentTransaction" ng-if="$ctrl.state.activeEditPlanPanel === $ctrl.state.EditPlanPanels.PLAN_SUMMARY"></plan-summary>
      <!-- Add a div that will overlay all the controls above. The div will be visible when the controls need to be disabled. -->
      <div class="disable-sibling-controls"
           ng-hide="$ctrl.currentTransaction">
      </div>
    </accordion-panel-contents>

  </accordion>
</div>
