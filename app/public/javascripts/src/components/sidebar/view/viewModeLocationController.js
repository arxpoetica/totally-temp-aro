const displayPropsLocation = [{
  "propertyName": "BusinessInformation",
  "levelOfDetail": 0,
  "format": "",
  "displayName": "Business Information",
  "enumTypeURL": "",
  "displayDataType": "object",
  "defaultValue": "",
  "visible": true,
  "editable": false
},
{
  "propertyName": "CompetitorInformation",
  "levelOfDetail": 0,
  "format": "",
  "displayName": "Competitor Information",
  "enumTypeURL": "",
  "displayDataType": "object",
  "defaultValue": "",
  "visible": true,
  "editable": false
},
{
  "propertyName": "NetworkInformation",
  "levelOfDetail": 0,
  "format": "",
  "displayName": "Network Information",
  "enumTypeURL": "",
  "displayDataType": "object",
  "defaultValue": "",
  "visible": true,
  "editable": false
},
{
  "propertyName": "ProductInformation",
  "levelOfDetail": 0,
  "format": "",
  "displayName": "Product Information",
  "enumTypeURL": "",
  "displayDataType": "object",
  "defaultValue": "",
  "visible": true,
  "editable": false
},
{
  "propertyName": "MiscInformation",
  "levelOfDetail": 0,
  "format": "",
  "displayName": "Miscellaneous Information",
  "enumTypeURL": "",
  "displayDataType": "object",
  "defaultValue": "",
  "visible": true,
  "editable": false
}]

const displayPropsBusinessInformation = [
  {
    "propertyName": "Name",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Name",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "Address",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Address",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "Industry",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Industry",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "DnBTier",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "D & B Tier",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "wirecenter",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Wirecenter",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "latLng",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Lat / Lng",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  }
]

const displayPropsPrimaryCompetitor = [{
  "propertyName": "PrimaryCompetitor",
  "levelOfDetail": 1,
  "format": "",
  "displayName": "PrimaryCompetitor",
  "enumTypeURL": "",
  "displayDataType": "string",
  "defaultValue": "",
  "visible": true,
  "editable": false
}]

const displayPropsNetworkInformation = [
  {
    "propertyName": "NetworkType",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Network Type",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "FiosCapableInd",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Fios Capable",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "HSICapableInd",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "HSI Capable",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "MaxHSISpeed",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Max HSI Speed",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "CPE_COMPOSITE_RANKING_SCORE",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "CPE Score",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  }
]

const displayPropsProductInformation = [
  {
    "propertyName": "eia",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "EIA",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "ereachpath",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "eREACH",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "ipvpn",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "IPVPN",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "voip",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "VOIP",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "metroE",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "MetroE",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "MaxSpeed",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "MaxSpeed",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "MaxQoS",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "MaxQoS",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  }
]

const displayPropsMiscInformation = [
  {
    "propertyName": "tabblock_id",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Census Block",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "number_of_households",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Number of Households",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "number_of_businesses",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Number of Businesses",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "number_of_towers",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Number of towers",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "distance_to_client_fiber",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Distance From Existing Network:",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  },
  {
    "propertyName": "distance_to_planned_network",
    "levelOfDetail": 1,
    "format": "",
    "displayName": "Distance From Planned Network",
    "enumTypeURL": "",
    "displayDataType": "string",
    "defaultValue": "",
    "visible": true,
    "editable": false
  }
]
class ViewModeLocationController {

  constructor($http, $timeout, state, configuration) {
    this.$http = $http
    this.$timeout = $timeout
    this.state = state
    this.configuration = configuration
    this.plan = null
    this.selectedLocationInfo = null
    this.map_url = null
    this.currentUser = state.loggedInUser
    this.selectedLocation = null

    this.planSubscription = state.plan.subscribe((plan) => {
      this.plan = plan
    })

    this.mapFeaturesSelectedSubscription = state.mapFeaturesSelectedEvent.subscribe((options) => {
      //In ruler mode click should not perform any view action's
      if(this.state.selectedDisplayMode.getValue() === state.displayModes.VIEW && 
        this.state.selectedTargetSelectionMode === this.state.targetSelectionModes.SINGLE_PLAN_TARGET &&
        //Don't open location view mode when in location edit view
        this.state.activeViewModePanel != this.state.viewModePanels.EDIT_LOCATIONS &&
        !this.state.isRulerEnabled) {
        var locationsList = []
        if (options.hasOwnProperty('locations')) locationsList = options.locations
        
        
        // Update state's selected location list 
        if (options.locations && options.locations.length > 0 && options.locations[0].location_id) {
          
          var selectedFeature = null
          var locationId = null
          for (var featureI = 0; featureI < locationsList.length; featureI++){
            var feature = locationsList[featureI]
            if ( feature.hasOwnProperty('location_id') ){
              locationId = feature.location_id
            }else if ( feature.hasOwnProperty('id') ){
              locationId = feature.id
            }
            
            if (null != locationId){
              selectedFeature = feature
              break
            }
          }
          
          this.selectedLocationObjectId = feature.object_id
          this.toggleAuditLog = false
          this.updateSelectedState(feature, locationId)
          this.getLocationInfo(this.plan.id,locationId,feature.object_id)
            .then(locationInfo => this.showStaticMap(locationInfo))
            .catch((err) => console.error(err))
        } else {
          this.selectedLocationInfo = null
        }
      }
    })
    
    this.clearViewModeSubscription = state.clearViewMode.subscribe((clear) => {
      if(clear){
        this.selectedLocationInfo = null
        this.updateSelectedState()
      }
    })
  }

  getAttributeValue(attributes, key) {
    return attributes.filter((item) => item.key === key)[0].value
  }

  // Get the location Information
  getLocationInfo(planId, id, objectId){
    return this.$http.get(`/locations/${planId}/${id}/show`)
      .then((result) => {

        // Save the selected location info in the hierarchical manner that we want.
        // ALL HARDCODING FOR NOW!!!
        const locationInfo = result.data
        var selectedLocationInfo = {
          geog: locationInfo.geog,
          BusinessInformation: {
            Name: locationInfo.attributes.filter((item) => item.key === 'BusinessName')[0].value,
            Address: locationInfo.address,
            Industry: locationInfo.attributes.filter((item) => item.key === 'dontuse_industry_id')[0].value,
            DnBTier: locationInfo.attributes.filter((item) => item.key === 'locationCategory')[0].value,
            wirecenter: locationInfo.attributes.filter((item) => item.key === 'CLLI8')[0].value,
            latLng: `${locationInfo.geog.coordinates[1]}  ${locationInfo.geog.coordinates[0]}`,
            getDisplayProperties: () => displayPropsBusinessInformation
          },
          CompetitorInformation: {
            PrimaryCompetitor: locationInfo.attributes.filter((item) => item.key === 'PrimaryCompetitor')[0].value,
            getDisplayProperties: () => displayPropsPrimaryCompetitor
          },
          NetworkInformation: {
            NetworkType: locationInfo.attributes.filter((item) => item.key === 'network')[0].value,
            FiosCapableInd: locationInfo.attributes.filter((item) => item.key === 'FiosCapableInd')[0].value,
            HSICapableInd: locationInfo.attributes.filter((item) => item.key === 'HSICapableInd')[0].value,
            MaxHSISpeed: locationInfo.attributes.filter((item) => item.key === 'MaxSpeed')[0].value,
            CPE_COMPOSITE_RANKING_SCORE: locationInfo.attributes.filter((item) => item.key === 'CPE_COMPOSITE_RANKING_SCORE')[0].value,
            getDisplayProperties: () => displayPropsNetworkInformation
          },
          ProductInformation: {
            eia: locationInfo.attributes.filter((item) => item.key === 'eia')[0].value,
            ereachpath: locationInfo.attributes.filter((item) => item.key === 'ereachpath')[0].value,
            ipvpn: locationInfo.attributes.filter((item) => item.key === 'ipvpn')[0].value,
            voip: locationInfo.attributes.filter((item) => item.key === 'voip')[0].value,
            metroE: locationInfo.attributes.filter((item) => item.key === 'metroE')[0].value,
            MaxSpeed: locationInfo.attributes.filter((item) => item.key === 'MaxSpeed')[0].value,
            MaxQoS: locationInfo.attributes.filter((item) => item.key === 'MaxQoS')[0].value,
            getDisplayProperties: () => displayPropsProductInformation
          },
          MiscInformation: {
            tabblock_id: locationInfo.tabblock_id,
            number_of_households: locationInfo.number_of_households,
            number_of_businesses: locationInfo.number_of_businesses,
            number_of_towers: locationInfo.number_of_towers,
            distance_to_client_fiber: `${locationInfo.distance_to_client_fiber} m`,
            distance_to_planned_network: `${locationInfo.distance_to_planned_network} m`,
            getDisplayProperties: () => displayPropsMiscInformation
          },
          getDisplayProperties: () => displayPropsLocation
        }
        return selectedLocationInfo
      })
  }
  
  updateSelectedState(feature, id){
    var selectedViewFeaturesByType = this.state.selectedViewFeaturesByType.getValue()
    selectedViewFeaturesByType.location = {}
    if ('undefined' != typeof feature && 'undefined' != typeof id){
      selectedViewFeaturesByType.location[ id ] = feature
    }
    this.state.StateViewMode.reloadSelectedViewFeaturesByType(this.state,selectedViewFeaturesByType)
  }
  
  showStaticMap(locationInfo) {
    this.selectedLocationInfo = locationInfo
    this.showAttributes = (this.currentUser.perspective === 'sales_engineer' || this.currentUser.perspective === 'account_exec') && !angular.equals(locationInfo.attributes, {})
    
    var google_maps_key = this.configuration.google_maps_key
    var coordinates = locationInfo.geog.coordinates[1] + ',' + locationInfo.geog.coordinates[0]
    var params = {
      center: coordinates,
      zoom: 13,
      size: '325x110',
      scale: 2,
      maptype: 'roadmap',
      markers: 'color:red|label:L|' + coordinates,
      key: google_maps_key
    }
    this.map_url = 'https://maps.googleapis.com/maps/api/staticmap?' +
      _.keys(params).map((key) => key + '=' + encodeURIComponent(params[key])).join('&')
    
    this.state.activeViewModePanel = this.state.viewModePanels.LOCATION_INFO
    this.$timeout()
  }

  showDetailLocationInfo() {
    this.selectedLocationInfo.id = +this.selectedLocationInfo.location_id      
    this.state.showDetailedLocationInfo.next(this.selectedLocationInfo)
  }

  viewSelectedLocation(selectedLocation) {
    //console.log(selectedLocation)
    this.selectedLocationObjectId = selectedLocation.objectId
    this.updateSelectedState(selectedLocation, selectedLocation.id)
    this.getLocationInfo(this.plan.id,selectedLocation.id,selectedLocation.objectId)
    .then(locationInfo => this.showStaticMap(locationInfo))
    .then(() => {
      map.setCenter({ lat: this.selectedLocationInfo.geog.coordinates[1], lng: this.selectedLocationInfo.geog.coordinates[0] })
      const ZOOM_FOR_LOCATION_SEARCH = 17
      this.state.requestSetMapZoom.next(ZOOM_FOR_LOCATION_SEARCH)
    })
  }
  
  $onDestroy() {
    this.planSubscription.unsubscribe()
    this.mapFeaturesSelectedSubscription.unsubscribe()
    this.clearViewModeSubscription.unsubscribe()
  }
}

ViewModeLocationController.$inject = ['$http', '$timeout', 'state', 'configuration']

export default ViewModeLocationController