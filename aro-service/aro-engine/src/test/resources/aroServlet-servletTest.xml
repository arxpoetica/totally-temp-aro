<beans xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:mvc="http://www.springframework.org/schema/mvc"
	xmlns:task="http://www.springframework.org/schema/task" xmlns:tx="http://www.springframework.org/schema/tx"
	xmlns:jpa="http://www.springframework.org/schema/data/jpa" xmlns="http://www.springframework.org/schema/beans"
    xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans
		http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context
		http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/mvc
		http://www.springframework.org/schema/mvc/spring-mvc.xsd
		http://www.springframework.org/schema/task
		http://www.springframework.org/schema/task/spring-task.xsd
		http://www.springframework.org/schema/tx
		http://www.springframework.org/schema/tx/spring-tx.xsd
		http://www.springframework.org/schema/data/jpa
		http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
        http://www.springframework.org/schema/util
        http://www.springframework.org/schema/util/spring-util.xsd">

	<bean id="contentManager"
		class="org.springframework.web.accept.ContentNegotiationManagerFactoryBean">
		<property name="favorPathExtension" value="true" />
		<property name="ignoreAcceptHeader" value="true" />
		<property name="defaultContentType" value="application/json" />
		<property name="useJaf" value="false" />
		<property name="favorParameter" value="true" />
		<property name="parameterName" value="mediaType" />
		<property name="mediaTypes">
			<map>
				<entry key="json" value="application/json" />
				<entry key="html" value="text/html" />
				<entry key="xml" value="application/xml" />
				<entry key="text" value="text/plain" />
			</map>
		</property>
	</bean>

	<mvc:annotation-driven
		content-negotiation-manager="contentManager">
		<mvc:message-converters>
			<ref bean="jsonMessageConverter" />
		</mvc:message-converters>
	</mvc:annotation-driven>

	<context:component-scan base-package="com.altvil"/>
 

	<task:executor id="myExecutor" pool-size="1" />
	
	<task:annotation-driven executor="myExecutor"
		scheduler="myScheduler" />

	<task:scheduler id="myScheduler" pool-size="1" />
	
	<bean
		class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter">
		<property name="messageConverters">
			<list>
				<ref bean="jsonMessageConverter" />
			</list>
		</property>
	</bean>

	<bean id="jsonMessageConverter"
		class="org.springframework.http.converter.json.MappingJackson2HttpMessageConverter">
		<property name="objectMapper">
			<bean class="com.altvil.aro.persistence.HibernateAwareObjectMapper" />
		</property>
	</bean>

	<bean id="contentNegotiationManager"
		class="org.springframework.web.accept.ContentNegotiationManagerFactoryBean">
		<property name="defaultContentType" value="application/json" />
	</bean>

	<context:property-placeholder location="classpath*:/aroConfig.properties" />

	<bean
		class="org.springframework.context.support.PropertySourcesPlaceholderConfigurer">
		<property name="locations">
			<list>
				<value>classpath*:aroConfig.properties</value>
			</list>
		</property>
	</bean>

	<tx:annotation-driven transaction-manager="transactionManager" />
	
	<bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
		<property name="entityManagerFactory" ref="entityManagerFactory" />
	</bean>
	
	<bean id="aroDataSource" class="org.apache.commons.dbcp2.BasicDataSource"
		destroy-method="close">
		<property name="driverClassName" value="org.postgis.DriverWrapper" />
		<property name="url"
			value="jdbc:postgresql_postGIS://${PGHOST}:${PGPORT}/${PGDATABASE}" />
		<property name="username" value="${PGUSER}" />
		<property name="password" value="${PGPASSWORD}" />
		<property name="accessToUnderlyingConnectionAllowed" value="true" />
	</bean>

	<bean id="entityManagerFactory"
		class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
		<property name="dataSource" ref="aroDataSource" />
		<property name="packagesToScan" value="com.altvil" />
		<property name="jpaVendorAdapter">
			<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter">
				<property name="showSql" value="false" />
				<property name="databasePlatform"
					value="com.altvil.aro.persistence.JsonPostgisHibernateDialect" />
			</bean>
		</property>

		<property name="jpaProperties">
			<props>
				<prop key="hibernate.hbm2ddl.auto">validate</prop>
			</props>
		</property>
	</bean>
	
    <bean class="org.springframework.mock.web.MockServletContext"/>    

	<bean id="entityManager"
		class="org.springframework.orm.jpa.support.SharedEntityManagerBean">
		<property name="entityManagerFactory" ref="entityManagerFactory" />
	</bean>
	
	<jpa:repositories base-package="com.altvil"
		repository-impl-postfix="Impl" entity-manager-factory-ref="entityManagerFactory"
		transaction-manager-ref="transactionManager" />

	<mvc:resources mapping="swagger-ui.html" location="classpath:/META-INF/resources/" />
	
	<mvc:resources mapping="/webjars/**"
		location="classpath:/META-INF/resources/webjars/" />


<!-- ***************************** -->
<!-- IGNITE GRID CONFIGURATIONS    -->
<!-- ***************************** -->
		
    <import resource="classpath:/META-INF/aroServlet-igniteConfig-abstract.xml"/>
    
	<!-- NOTE the IgniteSpringBean bean id is used for Autowiring, while 
		 the configuration's gridName is the actual Ignite grid being used.  
		 This abstraction provides easy reconfiguration when using multiple grids. 
		 For easy reconfiguration, autowire to the alias (below) instead of actual bean id. -->
		 
	<bean id="singleIgniteGrid" autowire="byName" class="org.apache.ignite.IgniteSpringBean">
		<property name="configuration">
	        <bean parent="ignite-abstract.cfg">  <!-- Use bean parent "ignite-abstract-IDE.cfg" when running in IDE -->
	        	<property name="clientMode" value="true"/>
	        	        
		        <property name="cacheConfiguration">
		        	<list>
						<bean parent="basicCache.cfg">
							<property name="name" value="NetworkService_LocationDemandsByWCID"/>
							<property name="statisticsEnabled" value="false"/>
						</bean>
						<bean parent="basicCache.cfg">
							<property name="name" value="NetworkService_RoadLocationsByWCID"/>
							<property name="statisticsEnabled" value="false"/>
						</bean>
						<bean parent="basicCache.cfg">
							<property name="name" value="NetworkService_FiberSourcesByWCID"/>
							<property name="statisticsEnabled" value="false"/>
						</bean>
						<bean parent="basicCache.cfg">
							<property name="name" value="NetworkService_RoadEdgesByWCID"/>
							<property name="statisticsEnabled" value="false"/>
						</bean>
					</list>
		    	</property>
	        	
	        </bean>
	    </property>
 	</bean>
 	
 	<!-- Alias the defined grids so compute/cache/services can be 
 		 moved to different clusters without code changes.  When autowiring,
 		 use method injection based on these aliases only. -->
	<alias name="singleIgniteGrid" alias="networkServiceIgniteGrid"/>
 	
</beans>